import 'package:flutter/material.dart';
import 'student.dart';
import 'authService.dart';
import 'loginPage.dart';

class SignUpPage extends StatefulWidget {
  @override
  _SignUpPageState createState() => _SignUpPageState();
}

class _SignUpPageState extends State<SignUpPage> {
  final _authService = AuthService();

  // Controllers for all fields
  final emailController = TextEditingController();
  final usernameController = TextEditingController();
  final passwordController = TextEditingController();
  final firstNameController = TextEditingController();
  final lastNameController = TextEditingController();
  final universityController = TextEditingController();
  final majorController = TextEditingController();
  final phoneController = TextEditingController();
  final levelController = TextEditingController();
  final gpaController = TextEditingController();

  /// Sign up function
  void signUp() async {
    try {
      Student newStudent = Student(
        id: '',
        firstName: firstNameController.text.trim(),
        lastName: lastNameController.text.trim(),
        username: usernameController.text.trim(),
        email: emailController.text.trim(),
        phoneNumber: phoneController.text.trim(),
        university: universityController.text.trim(),
        major: majorController.text.trim(),
        level: levelController.text.trim(),
        gpa: gpaController.text.isEmpty ? null : double.tryParse(gpaController.text.trim()),
        expectedGraduation: null,
        skills: [],
        profilePicture: null,
        shortSummary: null,
        supportingDocuments: [],
        resume: {},
        followedCompanies: [],
        bookmarkedOpportunities: [],
        applications: [],
        notifications: [],
      );

      // Domain check, example: "@university.edu"
      await _authService.signUp(newStudent, passwordController.text.trim(), "@university.edu");

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Account created! Please verify your email.')),
      );

      Navigator.pushReplacement(context, MaterialPageRoute(builder: (_) => LoginPage()));
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Error: $e')));
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Sign Up')),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(16.0),
        child: Column(
          children: [
            TextField(controller: emailController, decoration: InputDecoration(labelText: 'University Email')),
            TextField(controller: usernameController, decoration: InputDecoration(labelText: 'Username')),
            TextField(controller: passwordController, decoration: InputDecoration(labelText: 'Password'), obscureText: true),
            TextField(controller: firstNameController, decoration: InputDecoration(labelText: 'First Name')),
            TextField(controller: lastNameController, decoration: InputDecoration(labelText: 'Last Name')),
            TextField(controller: universityController, decoration: InputDecoration(labelText: 'University')),
            TextField(controller: majorController, decoration: InputDecoration(labelText: 'Major')),
            TextField(controller: phoneController, decoration: InputDecoration(labelText: 'Phone Number')),
            TextField(controller: levelController, decoration: InputDecoration(labelText: 'Level (Optional)')),
            TextField(controller: gpaController, decoration: InputDecoration(labelText: 'GPA (Optional)')),
            SizedBox(height: 20),
            ElevatedButton(onPressed: signUp, child: Text('Create Account')),
          ],
        ),
      ),
    );
  }
}
